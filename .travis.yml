matrix:
  allow_failures:
  - os: windows
  include:
  - os: osx
    language: node_js
    node_js:
    - node
    env:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
  - os: linux
    language: node_js
    node_js:
    - node
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - gcc-multilib
        - g++-8
        - g++-multilib
        - icnsutils
        - graphicsmagick
        - xz-utils
        - xorriso
        - rpm
  - os: windows
    language: node_js
    node_js:
    - node
    env:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder

before_cache:
- rm -rf $HOME/.cache/electron-builder/wine

cache:
  yarn: true
  directories:
  - node_modules
  - "$(npm config get prefix)/lib/node_modules"
  - flow-typed
  - "$HOME/.cache/electron"
  - "$HOME/.cache/electron-builder"

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CXX="g++-8"; fi

install:
  - yarn --ignore-engines
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      /sbin/start-stop-daemon \
      --start \
      --quiet \
      --pidfile /tmp/custom_xvfb_99.pid \
      --make-pidfile \
      --background \
      --exec /usr/bin/Xvfb \
      -- :99 -ac -screen 0 1280x1024x16
    else
      :
    fi

services:
  - xvfb

before_script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export DISPLAY=:99.0; fi
  # - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sh -e /etc/init.d/xvfb start; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sleep 3; fi

script:
  - yarn package-ci
  - yarn lint
  - yarn flow
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then yarn test; fi
  - yarn build-e2e
  - yarn test-e2e

deploy:
  provider: releases
  api_key:
    secure: "pZmh3f1J9q9v/iuynaAu1cJDokGFBrvZvum5izR+xr4SE/s5XYB4bfEPNvKkPLAyuzQe5TEJCs3IghKiRtLxp8m12Oma5h7wU3fNxLXA22L/h1zgxH5GQZw2D2UoKrSI1ZEMfDfAmSiPHiBGaF/g8f6jlV9bKjtH/Zg8lxupz1ch8SKomDr3ROPqSOjin3YiX7GfJzm/e7W6Ix0Tk3+yfJBo056JHo/yYYN/T3lxHxKzO/vqKLjYhOVo3XUnYOgLBzpWMbxJH/URle8/vx3z7AaupJLzy+F8LDMg36pu2MtjmgLaOGKL1JfTXtp9bfdWYd80vmfHwyMvSj7CMQTB5EgJAOuq1qw7C56P4oGGLI8ov5lIFvhoTpJ6Yy9/fOVg3tl6RKgzX8quM2oHJPd8EQIzQs1O9yoDSkD1hMinD3p6cdzLLJUalBZ3sivambV3QFX+shLOjgTVicwu3e/Iyym279oKNs8k4KwOnGnW0hC5kdp12obbi67v78vTOgo+gfgIQmpHxefilDOaCgqK8SjNc9WJOQ8ZgNS8j4nTp/gAP+0IKiqbROj/FdZOd1sgyZ2K44t8gzOonEEqUWEdhx+7YK3OA96HuKuFwQ6vcoOCysK3eNTMm/wfuS1X8CntsMkQIk5mM4osPVqGm/q39Prbtze80NL8INul6ENs/48="
  file:
    - release/TabloTools*.AppImage
    - release/TabloTools Setup*.exe
    - release/TabloTools-0.0.1-mac.zip
  skip_cleanup: true
  on:
    tags: true
